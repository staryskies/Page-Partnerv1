<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Onboarding - PagePartner</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    /* Your provided CSS here */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }
    body {
      background-color: #FCFAF7;
      color: #1A365D;
      line-height: 1.6;
    }
    .container {
      max-width: 800px;
      margin: 40px auto;
      padding: 0 20px;
    }
    .progress-container {
      width: 100%;
      background-color: #E2E8F0;
      height: 8px;
      border-radius: 4px;
      margin-bottom: 30px;
      position: relative;
      overflow: hidden;
    }
    #progress-bar {
      height: 100%;
      background-color: #2A9D8F;
      width: 0;
      transition: width 0.3s ease;
    }
    .form-section {
      display: none;
    }
    .form-section.active {
      display: block;
    }
    .form-section h2 {
      font-size: 1.5rem;
      font-weight: 600;
      color: #1A365D;
      margin-bottom: 20px;
    }
    .form-section p {
      color: #4A5568;
      margin-bottom: 25px;
      font-size: 0.95rem;
    }
    .welcome-section {
      text-align: center;
      padding: 20px 0;
    }
    .welcome-section h2 {
      font-size: 1.8rem;
      margin-bottom: 20px;
      color: #1A365D;
    }
    .welcome-section p {
      font-size: 1.1rem;
      margin-bottom: 30px;
      color: #4A5568;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
    .quest-features {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      margin-bottom: 40px;
    }
    .feature-item {
      background-color: rgba(42, 157, 143, 0.1);
      border-radius: 12px;
      padding: 15px;
      width: 160px;
      text-align: center;
    }
    .feature-icon {
      font-size: 24px;
      color: #2A9D8F;
      margin-bottom: 10px;
    }
    .feature-text {
      font-size: 0.9rem;
      color: #1A365D;
    }
    .start-quest-btn {
      background-color: #2A9D8F;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 15px 40px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(42, 157, 143, 0.3);
    }
    .start-quest-btn:hover {
      background-color: #238177;
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(42, 157, 143, 0.4);
    }
    .checkbox-item input:checked + .checkbox-label,
    .radio-item input:checked + .radio-label {
      background-color: rgba(42, 157, 143, 0.1);
      border-color: #2A9D8F;
    }
    .checkbox-label:hover,
    .radio-label:hover {
      background-color: rgba(42, 157, 143, 0.05);
    }
    .entry-field {
      width: 100%;
      margin-bottom: 10px;
    }
    .entry-field textarea {
      width: 100%;
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 0.95rem;
      resize: vertical;
      min-height: 100px;
    }
    .help-text {
      font-size: 0.85rem;
      color: #718096;
      margin-top: 5px;
    }
    .form-navigation {
      display: flex;
      justify-content: space-between;
      margin-top: 40px;
    }
    .prev-btn {
      background-color: #E2E8F0;
      color: #4A5568;
      border: none;
      border-radius: 8px;
      padding: 12px 25px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .prev-btn:hover {
      background-color: #CBD5E0;
    }
    .next-btn,
    .submit-btn {
      background-color: #2A9D8F;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 25px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .next-btn:hover,
    .submit-btn:hover {
      background-color: #238177;
    }
    .next-btn:disabled,
    .submit-btn:disabled {
      background-color: #A0AEC0;
      cursor: not-allowed;
    }
    .error-message {
      color: #E53E3E;
      font-size: 0.85rem;
      margin-top: 5px;
      display: none;
    }
    @media (max-width: 768px) {
      .quiz-form {
        padding: 30px 20px;
      }
      .checkbox-group,
      .radio-group {
        grid-template-columns: 1fr;
      }
      .quest-features {
        gap: 10px;
      }
      .feature-item {
        width: 140px;
        padding: 10px;
      }
    }
    /* Additional styles for form elements */
    .form-group {
      margin-bottom: 20px;
    }
    .checkbox-group, .radio-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
    }
    .checkbox-label, .radio-label {
      display: block;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      cursor: pointer;
    }
    .range-container {
      margin-top: 10px;
    }
    .range-slider {
      width: 100%;
    }
    .range-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 5px;
    }
    .selected-value {
      margin-top: 10px;
      color: #2A9D8F;
    }
    .file-upload {
      text-align: center;
    }
    .file-upload-preview {
      display: none;
      max-width: 200px;
      margin: 10px auto;
      border-radius: 8px;
    }
    .file-upload-label {
      display: block;
      padding: 20px;
      border: 2px dashed #ddd;
      border-radius: 8px;
      cursor: pointer;
    }
    .file-upload-icon {
      font-size: 24px;
      color: #2A9D8F;
    }
    .file-upload-text {
      margin-top: 10px;
    }
    .file-upload-text small {
      color: #718096;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="progress-container">
      <div id="progress-bar"></div>
    </div>
    <form id="onboarding-form">
      <!-- Your provided HTML sections here -->
      <div class="form-section active" id="section-welcome">
        <div class="welcome-section">
          <h2>Discover Your Perfect Reading Experience</h2>
          <p>Fill out our quick questionnaire with 8 simple questions, and we'll personalize your PagePartner experience to match your unique reading preferences.</p>
          <div class="quest-features">
            <div class="feature-item">
              <i class="fas fa-book feature-icon"></i>
              <div class="feature-text">Tailored Book Recommendations</div>
            </div>
            <div class="feature-item">
              <i class="fas fa-users feature-icon"></i>
              <div class="feature-text">Connect with Fellow Readers</div>
            </div>
            <div class="feature-item">
              <i class="fas fa-chart-line feature-icon"></i>
              <div class="feature-text">Track Reading Progress</div>
            </div>
            <div class="feature-item">
              <i class="fas fa-calendar-alt feature-icon"></i>
              <div class="feature-text">Local Book Events</div>
            </div>
          </div>
          <button type="button" class="start-quest-btn" onclick="goToSection(2)">Start Quest</button>
        </div>
      </div>

      <div class="form-section" id="section-2">
        <h2>Add a profile picture</h2>
        <p>This is completely optional. You can continue without adding a photo.</p>
        <div class="form-group">
          <div class="file-upload">
            <img id="profile-preview" class="file-upload-preview" alt="Profile Preview">
            <label for="profile-picture" class="file-upload-label">
              <i class="fas fa-cloud-upload-alt file-upload-icon"></i>
              <div class="file-upload-text">
                <span>Drag & drop a photo here or click to browse</span>
                <small>JPG, PNG or GIF (max 5MB)</small>
              </div>
            </label>
            <input type="file" id="profile-picture" name="profile_picture" accept="image/*" style="display: none;">
          </div>
        </div>
        <div class="form-navigation">
          <button type="button" class="prev-btn" onclick="goToSection('welcome')">Previous</button>
          <button type="button" class="next-btn" id="next-2" onclick="goToSection(3)">Next</button>
        </div>
      </div>

      <div class="form-section" id="section-3">
        <h2>Where are you located?</h2>
        <p>This helps us connect you with local book clubs and events.</p>
        <div class="form-group">
          <label for="user-location">Your Location</label>
          <input type="text" class="form-control" id="user-location" name="user_location" placeholder="City, Country" required>
          <div class="error-message" id="error-location">Please enter your location</div>
        </div>
        <div class="form-navigation">
          <button type="button" class="prev-btn" onclick="goToSection(2)">Previous</button>
          <button type="button" class="next-btn" id="next-3" onclick="validateAndProceed(3, 4)">Next</button>
        </div>
      </div>

      <div class="form-section" id="section-4">
        <h2>What genres do you enjoy reading?</h2>
        <p>Select all that apply. This helps us suggest books you'll love.</p>
        <div class="form-group">
          <div class="checkbox-group">
            <div class="checkbox-item">
              <input type="checkbox" id="genre-fiction" name="genres[]" value="Fiction" class="genre-checkbox">
              <label class="checkbox-label" for="genre-fiction">Fiction</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="genre-nonfiction" name="genres[]" value="Non-Fiction" class="genre-checkbox">
              <label class="checkbox-label" for="genre-nonfiction">Non-Fiction</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="genre-mystery" name="genres[]" value="Mystery" class="genre-checkbox">
              <label class="checkbox-label" for="genre-mystery">Mystery</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="genre-scifi" name="genres[]" value="Science Fiction" class="genre-checkbox">
              <label class="checkbox-label" for="genre-scifi">Science Fiction</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="genre-fantasy" name="genres[]" value="Fantasy" class="genre-checkbox">
              <label class="checkbox-label" for="genre-fantasy">Fantasy</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="genre-romance" name="genres[]" value="Romance" class="genre-checkbox">
              <label class="checkbox-label" for="genre-romance">Romance</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="genre-horror" name="genres[]" value="Horror" class="genre-checkbox">
              <label class="checkbox-label" for="genre-horror">Horror</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="genre-biography" name="genres[]" value="Biography" class="genre-checkbox">
              <label class="checkbox-label" for="genre-biography">Biography</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="genre-history" name="genres[]" value="History" class="genre-checkbox">
              <label class="checkbox-label" for="genre-history">History</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="genre-poetry" name="genres[]" value="Poetry" class="genre-checkbox">
              <label class="checkbox-label" for="genre-poetry">Poetry</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="genre-classics" name="genres[]" value="Classics" class="genre-checkbox">
              <label class="checkbox-label" for="genre-classics">Classics</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="genre-selfhelp" name="genres[]" value="Self-Help" class="genre-checkbox">
              <label class="checkbox-label" for="genre-selfhelp">Self-Help</label>
            </div>
          </div>
          <div class="error-message" id="error-genres">Please select at least one genre</div>
        </div>
        <div class="form-navigation">
          <button type="button" class="prev-btn" onclick="goToSection(3)">Previous</button>
          <button type="button" class="next-btn" id="next-4" onclick="validateAndProceed(4, 5)">Next</button>
        </div>
      </div>

      <div class="form-section" id="section-5">
        <h2>Who are your favorite authors?</h2>
        <p>Share a few of your favorite authors so we can find similar writers you might enjoy.</p>
        <div class="form-group">
          <label for="favorite-authors">Favorite Authors</label>
          <div class="entry-field">
            <textarea id="favorite-authors" name="favorite_authors" placeholder="Enter your favorite authors (separate with commas, line breaks, or semicolons)" required></textarea>
            <p class="help-text">For example: Jane Austen; Stephen King; Toni Morrison; Margaret Atwood</p>
          </div>
          <div class="error-message" id="error-authors">Please enter at least one author</div>
        </div>
        <div class="form-navigation">
          <button type="button" class="prev-btn" onclick="goToSection(4)">Previous</button>
          <button type="button" class="next-btn" id="next-5" onclick="validateAndProceed(5, 6)">Next</button>
        </div>
      </div>

      <div class="form-section" id="section-6">
        <h2>How many books do you typically read?</h2>
        <p>This helps us set appropriate reading goals and recommendations.</p>
        <div class="form-group">
          <label for="reading-pace">Books per month</label>
          <div class="range-container">
            <input type="range" class="range-slider" id="reading-pace" name="reading_pace" min="0" max="10" step="1" value="2">
            <div class="range-labels">
              <span>0</span>
              <span>5</span>
              <span>10+</span>
            </div>
            <div class="selected-value" id="pace-value">2 books per month</div>
          </div>
        </div>
        <div class="form-navigation">
          <button type="button" class="prev-btn" onclick="goToSection(5)">Previous</button>
          <button type="button" class="next-btn" id="next-6" onclick="validateAndProceed(6, 8)">Next</button>
        </div>
      </div>

      <div class="form-section" id="section-8">
        <h2>What are your primary reading goals?</h2>
        <p>This helps us understand why you read and tailor recommendations accordingly.</p>
        <div class="form-group">
          <div class="checkbox-group">
            <div class="checkbox-item">
              <input type="checkbox" id="goal-entertainment" name="goals[]" value="Entertainment" class="goal-checkbox">
              <label class="checkbox-label" for="goal-entertainment">Entertainment</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="goal-education" name="goals[]" value="Education" class="goal-checkbox">
              <label class="checkbox-label" for="goal-education">Learning/Education</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="goal-growth" name="goals[]" value="Personal Growth" class="goal-checkbox">
              <label class="checkbox-label" for="goal-growth">Personal Growth</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="goal-escape" name="goals[]" value="Escape" class="goal-checkbox">
              <label class="checkbox-label" for="goal-escape">Escape/Relaxation</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="goal-perspective" name="goals[]" value="Perspective" class="goal-checkbox">
              <label class="checkbox-label" for="goal-perspective">New Perspectives</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="goal-social" name="goals[]" value="Social" class="goal-checkbox">
              <label class="checkbox-label" for="goal-social">Social Discussion</label>
            </div>
          </div>
          <div class="error-message" id="error-goals">Please select at least one reading goal</div>
        </div>
        <div class="form-navigation">
          <button type="button" class="prev-btn" onclick="goToSection(6)">Previous</button>
          <button type="button" class="next-btn" id="next-8" onclick="validateAndProceed(8, 9)">Next</button>
        </div>
      </div>

      <div class="form-section" id="section-9">
        <h2>What books do you plan to read next?</h2>
        <p>Share a few books you're planning to read so we can help you track them.</p>
        <div class="form-group">
          <label for="to-read-list">Books To Read</label>
          <div class="entry-field">
            <textarea id="to-read-list" name="to_read_list" placeholder="Enter book titles you plan to read (separate with commas, line breaks, or semicolons)" required></textarea>
            <p class="help-text">For example: The Midnight Library; Project Hail Mary; Klara and the Sun</p>
          </div>
          <div class="error-message" id="error-books">Please enter at least one book</div>
        </div>
        <div class="form-navigation">
          <button type="button" class="prev-btn" onclick="goToSection(8)">Previous</button>
          <button type="button" class="next-btn" id="next-9" onclick="validateAndProceed(9, 10)">Next</button>
        </div>
      </div>

      <div class="form-section" id="section-10">
        <h2>What book length do you prefer?</h2>
        <p>We'll prioritize recommendations based on your preferred book length.</p>
        <div class="form-group">
          <div class="radio-group">
            <div class="radio-item">
              <input type="radio" id="length-short" name="book_length" value="Short" class="length-radio">
              <label class="radio-label" for="length-short">Short Reads<br><small>(Under 300 pages)</small></label>
            </div>
            <div class="radio-item">
              <input type="radio" id="length-medium" name="book_length" value="Medium" class="length-radio">
              <label class="radio-label" for="length-medium">Medium Length<br><small>(300-500 pages)</small></label>
            </div>
            <div class="radio-item">
              <input type="radio" id="length-long" name="book_length" value="Long" class="length-radio">
              <label class="radio-label" for="length-long">Long Books<br><small>(Over 500 pages)</small></label>
            </div>
            <div class="radio-item">
              <input type="radio" id="length-any" name="book_length" value="Any" class="length-radio">
              <label class="radio-label" for="length-any">No Preference</label>
            </div>
          </div>
          <div class="error-message" id="error-length">Please select a book length preference</div>
        </div>
        <div class="form-navigation">
          <button type="button" class="prev-btn" onclick="goToSection(9)">Previous</button>
          <button type="submit" class="submit-btn" id="submit-btn">Finish</button>
        </div>
      </div>
    </form>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      updateProgressBar(0, 8);

      const paceSlider = document.getElementById('reading-pace');
      const paceValue = document.getElementById('pace-value');
      if (paceSlider && paceValue) {
        paceSlider.addEventListener('input', function() {
          paceValue.textContent = this.value + ' books per month';
        });
      }

      const profileInput = document.getElementById('profile-picture');
      const profilePreview = document.getElementById('profile-preview');
      if (profileInput && profilePreview) {
        profileInput.addEventListener('change', function() {
          if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
              profilePreview.src = e.target.result;
              profilePreview.style.display = 'block';
            };
            reader.readAsDataURL(this.files[0]);
          }
        });
      }

      document.querySelectorAll('.genre-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', () => validateSection(4));
      });
      document.querySelectorAll('.goal-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', () => validateSection(8));
      });
      document.querySelectorAll('.length-radio').forEach(radio => {
        radio.addEventListener('change', () => validateSection(10));
      });
      document.getElementById('favorite-authors')?.addEventListener('input', () => validateSection(5));
      document.getElementById('to-read-list')?.addEventListener('input', () => validateSection(9));
      document.getElementById('user-location')?.addEventListener('input', () => validateSection(3));

      document.getElementById('onboarding-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        if (validateSection(10)) {
          const formData = {
            username: localStorage.getItem('username'), // Assumes user is logged in
            profile_picture: profilePreview.src !== '' ? profilePreview.src : null,
            user_location: document.getElementById('user-location').value,
            genres: Array.from(document.querySelectorAll('.genre-checkbox:checked')).map(cb => cb.value),
            favorite_authors: document.getElementById('favorite-authors').value,
            reading_pace: document.getElementById('reading-pace').value,
            goals: Array.from(document.querySelectorAll('.goal-checkbox:checked')).map(cb => cb.value),
            to_read_list: document.getElementById('to-read-list').value,
            book_length: document.querySelector('input[name="book_length"]:checked')?.value
          };

          try {
            const response = await fetch('/api/onboarding', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(formData)
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error || 'Failed to save onboarding data');
            alert('Thank you for sharing your preferences! Your personalized reading experience is ready.');
            window.location.href = '/index.html'; // Redirect to main app
          } catch (err) {
            console.error('Submit Error:', err);
            alert('Error saving preferences: ' + err.message);
          }
        }
      });

      if (document.querySelector('input[name="book_length"]:checked')) {
        validateSection(10);
      }
      document.getElementById('length-medium').checked = true;
      validateSection(10);
    });

    function goToSection(sectionNum) {
      const sections = document.querySelectorAll('.form-section');
      sections.forEach(section => section.classList.remove('active'));
      const targetSection = sectionNum === 'welcome' ? 
        document.getElementById('section-welcome') : 
        document.getElementById(`section-${sectionNum}`);
      if (targetSection) {
        targetSection.classList.add('active');
        let currentStep = sectionNum === 'welcome' ? 0 : 
          [2, 3, 4, 5, 6, 8, 9, 10].indexOf(sectionNum) + 1;
        updateProgressBar(currentStep, 8);
      }
      window.scrollTo(0, 0);
    }

    function updateProgressBar(currentStep, totalSteps) {
      const progressPercentage = (currentStep / totalSteps) * 100;
      document.getElementById('progress-bar').style.width = progressPercentage + '%';
    }

    function validateSection(sectionNum) {
      let isValid = true;
      const errorElement = document.getElementById(`error-${getErrorId(sectionNum)}`);
      if (errorElement) errorElement.style.display = 'none';

      switch (sectionNum) {
        case 2: break; // Optional
        case 3:
          if (!document.getElementById('user-location').value.trim()) {
            document.getElementById('error-location').style.display = 'block';
            isValid = false;
          }
          break;
        case 4:
          if (document.querySelectorAll('.genre-checkbox:checked').length === 0) {
            document.getElementById('error-genres').style.display = 'block';
            isValid = false;
          }
          break;
        case 5:
          if (!document.getElementById('favorite-authors').value.trim()) {
            document.getElementById('error-authors').style.display = 'block';
            isValid = false;
          }
          break;
        case 8:
          if (document.querySelectorAll('.goal-checkbox:checked').length === 0) {
            document.getElementById('error-goals').style.display = 'block';
            isValid = false;
          }
          break;
        case 9:
          if (!document.getElementById('to-read-list').value.trim()) {
            document.getElementById('error-books').style.display = 'block';
            isValid = false;
          }
          break;
        case 10:
          if (!document.querySelector('input[name="book_length"]:checked')) {
            document.getElementById('error-length').style.display = 'block';
            isValid = false;
          }
          break;
      }

      const nextButton = document.getElementById(`next-${sectionNum}`);
      if (nextButton) nextButton.disabled = !isValid;
      return isValid;
    }

    function validateAndProceed(currentSection, nextSection) {
      if (validateSection(currentSection)) goToSection(nextSection);
    }

    function getErrorId(sectionNum) {
      return { 3: 'location', 4: 'genres', 5: 'authors', 8: 'goals', 9: 'books', 10: 'length' }[sectionNum] || '';
    }

    async function completeOnboarding() {
      const username = localStorage.getItem('username');
      if (!username) {
        alert('You must be logged in to complete onboarding.');
        window.location.href = '/login.html';
        return;
      }
    
      const preferences = { /* Collect preferences from the form */ };
    
      try {
        const response = await fetch('/api/user/onboarding', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Username': username,
          },
          body: JSON.stringify(preferences),
        });
    
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to complete onboarding.');
        }
    
        window.location.href = '/index.html';
      } catch (err) {
        console.error('Onboarding Error:', err);
        alert(err.message);
      }
    }
  </script>
</body>
</html>